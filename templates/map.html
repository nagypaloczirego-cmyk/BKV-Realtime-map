
<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Térkép</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body,#map { height:100%; margin:0 }
#controls {
  position:absolute;
  top:10px;
  left:10px;
  z-index:1000;
  background:white;
  padding:10px;
  border-radius:8px;
}
select { width:200px; margin:4px 0 }
</style>
</head>

<body>

<div id="controls">
  <select id="routeFilter"></select>
  <select id="plateFilter"></select>
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([47.4979,19.0402],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const ICONS = {
  bus: "/icons/busz.png.png",
  tram: "/icons/villamos.png.png",
  trolley: "/icons/trolibusz.png.png",
  hev: "/icons/hév.png.png",
  vonat: "/icons/vonat.png"
};

function detectMode(v){
  const m=(v.vehicle_model||"").toLowerCase();
  if(m.includes("trol")) return "trolley";
  if(m.includes("bus")||m.includes("man")||m.includes("mercedes")) return "bus";
  if(m.includes("villamos")||m.includes("tram")) return "tram";
  return "vonat";
}

function iconFor(v){
  return L.icon({iconUrl:ICONS[detectMode(v)],iconSize:[32,32],iconAnchor:[16,16]});
}

let markers=[], vehicles=[];

async function refresh(){
  vehicles = await (await fetch("/api/vehicles",{cache:"no-store"})).json();

  routeFilter.innerHTML="<option value=''>Összes vonal</option>";
  [...new Set(vehicles.map(v=>v.route_id))].sort().forEach(r=>{
    routeFilter.innerHTML+=`<option>${r}</option>`;
  });

  plateFilter.innerHTML="<option value=''>Összes jármű</option>";
  [...new Set(vehicles.map(v=>v.license_plate))].sort().forEach(p=>{
    plateFilter.innerHTML+=`<option>${p}</option>`;
  });

  draw();
}

function draw(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  vehicles.forEach(v=>{
    if(routeFilter.value && v.route_id!==routeFilter.value) return;
    if(plateFilter.value && v.license_plate!==plateFilter.value) return;

    const m=L.marker([v.latitude,v.longitude],{icon:iconFor(v)})
      .bindPopup(`
        <b>${v.license_plate}</b><br>
        Vonal: ${v.route_id}<br>
        <a href="/vehicle/${v.vehicle_id}">Részletek</a>
      `);

    m.addTo(map);
    markers.push(m);
  });
}

routeFilter.onchange = plateFilter.onchange = draw;

refresh();
setInterval(refresh, 30000); // ✅ 30 mp
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Térkép</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body,#map { height:100%; margin:0 }
#controls {
  position:absolute;
  top:10px;
  left:10px;
  z-index:1000;
  background:white;
  padding:10px;
  border-radius:8px;
}
select { width:200px; margin:4px 0 }
</style>
</head>

<body>

<div id="controls">
  <select id="routeFilter"></select>
  <select id="plateFilter"></select>
</div>

<div id="map"></div>

<script>
const map = L.map('map').setView([47.4979,19.0402],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

const ICONS = {
  bus: "/icons/busz.png.png",
  tram: "/icons/villamos.png.png",
  trolley: "/icons/trolibusz.png.png",
  hev: "/icons/hév.png.png",
  vonat: "/icons/vonat.png"
};

function detectMode(v){
  const m=(v.vehicle_model||"").toLowerCase();
  if(m.includes("trol")) return "trolley";
  if(m.includes("bus")||m.includes("man")||m.includes("mercedes")) return "bus";
  if(m.includes("villamos")||m.includes("tram")) return "tram";
  return "vonat";
}

function iconFor(v){
  return L.icon({iconUrl:ICONS[detectMode(v)],iconSize:[32,32],iconAnchor:[16,16]});
}

let markers=[], vehicles=[];

async function refresh(){
  vehicles = await (await fetch("/api/vehicles",{cache:"no-store"})).json();

  routeFilter.innerHTML="<option value=''>Összes vonal</option>";
  [...new Set(vehicles.map(v=>v.route_id))].sort().forEach(r=>{
    routeFilter.innerHTML+=`<option>${r}</option>`;
  });

  plateFilter.innerHTML="<option value=''>Összes jármű</option>";
  [...new Set(vehicles.map(v=>v.license_plate))].sort().forEach(p=>{
    plateFilter.innerHTML+=`<option>${p}</option>`;
  });

  draw();
}

function draw(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];

  vehicles.forEach(v=>{
    if(routeFilter.value && v.route_id!==routeFilter.value) return;
    if(plateFilter.value && v.license_plate!==plateFilter.value) return;

    const m=L.marker([v.latitude,v.longitude],{icon:iconFor(v)})
      .bindPopup(`
        <b>${v.license_plate}</b><br>
        Vonal: ${v.route_id}<br>
        <a href="/vehicle/${v.vehicle_id}">Részletek</a>
      `);

    m.addTo(map);
    markers.push(m);
  });
}

routeFilter.onchange = plateFilter.onchange = draw;

refresh();
setInterval(refresh, 30000); // ✅ 30 mp
</script>

</body>
</html>

